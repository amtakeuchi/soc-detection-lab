# Detection Rule: Scheduled Task Persistence

## MITRE ATT&CK
- **Technique ID:** T1053.005
- **Technique Name:** Scheduled Task/Job: Scheduled Task
- **Tactic:** Persistence, Privilege Escalation, Execution
- **Severity:** Medium-High

## Description
Detects creation of scheduled tasks via the schtasks.exe utility. Attackers frequently use Windows scheduled tasks to maintain persistence after initial compromise, execute malicious code at specific times, or run commands with SYSTEM privileges. This detection focuses on identifying suspicious task creation patterns that may indicate malicious activity.

## Technical Background
Scheduled tasks in Windows allow programs to run automatically at specific times or in response to specific events (startup, logon, idle, etc.). The schtasks.exe command-line utility is the primary tool for creating and managing tasks. While legitimate administrators use scheduled tasks for maintenance and automation, attackers abuse this feature to:
- Maintain persistence after system reboots
- Execute malware with elevated privileges
- Run commands at specific intervals for C2 communication
- Establish backup access methods

## Detection Logic

### KQL Query (Kibana)
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "schtasks.exe"
```

### Enhanced Detection (Focus on Suspicious Tasks)
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "schtasks.exe" AND 
process.command_line: */create* AND
(process.parent.name: ("powershell.exe" OR "cmd.exe" OR "wscript.exe") OR
 process.command_line: (*\\AppData\\* OR *\\Temp\\* OR *\\Users\\Public\\*))
```

### Key Detection Fields
| Field | Value in Attack | Why It Matters |
|-------|----------------|----------------|
| `event.code` | 1 | Process Creation event |
| `process.name` | schtasks.exe | Task creation utility |
| `process.command_line` | `/create /tn "T1053_005_OnStartup"...` | Full command with task details |
| `process.parent.name` | cmd.exe | What launched schtasks |
| `user.name` | Administrator | User context |

## Test Case - Atomic Red Team

### Execution Command
```powershell
Invoke-AtomicTest T1053.005 -TestNumbers 1
```

### Expected Behavior
1. Test creates a scheduled task named "T1053_005_OnStartup"
2. Task configured to run at system startup (`/sc onstart`)
3. Executes calc.exe as SYSTEM (`/ru system /tr "cmd.exe /c calc.exe"`)
4. Sysmon Event ID 1 captures schtasks.exe execution
5. Detection rule triggers immediately

### Lab Test Results
- **Environment:** Windows 11 Pro (homelab.local)
- **User Context:** Administrator
- **Detection Time:** Immediate (<5 seconds)
- **Execution Date:** Feb 20, 2026 @ 14:17:36
- **Command Line:** `schtasks /create /tn "T1053_005_OnStartup" /sc onstart /ru system /tr "cmd.exe /c calc.exe"`
- **Task Name:** T1053_005_OnStartup
- **Evidence:** Full schtasks command captured in Sysmon logs

## False Positives

### Known Legitimate Uses
1. **IT Administration**
   - System maintenance scripts
   - Backup job scheduling
   - Automated updates and patches
   - **Frequency:** Common in enterprise environments

2. **Software Installation**
   - Application installers creating update tasks
   - Security software scheduling scans
   - **Frequency:** Moderate

3. **User Applications**
   - Productivity tools (OneDrive, Dropbox sync)
   - Cloud backup services
   - **Frequency:** Common

### Expected False Positive Rate
**10-20% without tuning**  
**<5% after tuning for environment**

## Tuning Recommendations

### Level 1 - Whitelist Known Good Tasks
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "schtasks.exe" AND
process.command_line: */create* AND
NOT process.command_line: (*GoogleUpdate* OR *OneDrive* OR *Adobe*)
```

### Level 2 - Focus on Suspicious Execution Paths
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "schtasks.exe" AND
process.command_line: */create* AND
process.command_line: (*\\AppData\\* OR *\\Temp\\* OR *\\Downloads\\* OR *\\Users\\Public\\*)
```

### Level 3 - Alert on SYSTEM Privilege Tasks from User Context
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "schtasks.exe" AND
process.command_line: (*/create* AND */ru*system*)
```

### Level 4 - Correlation Rules
Alert if scheduled task created AND file dropped in suspicious location within 5 minutes:
```kql
(event.code: 1 AND process.name: "schtasks.exe") OR
(event.code: 11 AND file.path: (*\\AppData\\* OR *\\Temp\\*))
```

## Investigation Playbook

### Immediate Actions (0-5 minutes)
1. **Extract Task Details**
   - Task name (`/tn` parameter)
   - Schedule type (`/sc` parameter)
   - Action to execute (`/tr` parameter)
   - User context (`/ru` parameter)

2. **Assess Threat Level**
   - **Critical:** Task runs executable from Temp/AppData as SYSTEM
   - **High:** Task executes PowerShell/cmd with encoded commands
   - **Medium:** Task from unknown software installer
   - **Low:** Task from known legitimate software

### Containment (5-15 minutes)
3. **Endpoint Actions**
   - If malicious: Delete the task immediately
```powershell
   schtasks /delete /tn "TASK_NAME" /f
```
   - Check if task already executed (check Task Scheduler history)
   - Identify and quarantine associated executable

4. **Prevent Re-creation**
   - Monitor for task re-creation attempts
   - Check for persistence mechanisms that might recreate task
   - Review scheduled tasks on endpoint for other suspicious entries

### Investigation (15+ minutes)
5. **Deeper Analysis**
   - Analyze executable referenced in task (`/tr` parameter)
   - Check file hash against threat intelligence
   - Review parent process - was it user-initiated or automated?
   - Search for similar tasks across other endpoints

6. **Timeline Analysis**
   - When was task created vs. when does it execute?
   - Review logon events around task creation time
   - Check for other suspicious activity from same user account
   - Examine network connections if task has executed

## Remediation Steps

### Immediate
1. Delete malicious scheduled task
2. Quarantine or delete associated executable
3. Review and remove any files dropped by task
4. Check for other persistence mechanisms (Run keys, services)
5. Force password reset for affected user account

### Short-term
6. Search all endpoints for same task name/hash
7. Review Task Scheduler logs for execution history
8. Check for lateral movement from affected system
9. Document IOCs (task names, file hashes, command patterns)
10. Update EDR signatures if applicable

### Long-term
11. Implement scheduled task monitoring/logging
12. Restrict schtasks.exe execution via AppLocker
13. Enable Task Scheduler operational logging
14. Deploy GPO to prevent non-admin task creation
15. Security awareness training on social engineering

## Prevention Recommendations

### Technical Controls
**Group Policy Restrictions:**
```
Computer Configuration → Windows Settings → Security Settings → 
Local Policies → User Rights Assignment → 
"Log on as a batch job" - Restrict to approved service accounts
```

**AppLocker Rules:**
```powershell
# Allow schtasks only from System32 and for approved admin groups
# Block execution from user-writable locations
```

**Task Scheduler Hardening:**
- Enable detailed logging: `Microsoft-Windows-TaskScheduler/Operational`
- Restrict task creation to admin groups
- Monitor `C:\Windows\System32\Tasks\` directory for file changes

**Least Privilege:**
- Remove unnecessary admin rights
- Require approval for scheduled task creation
- Implement just-in-time admin access

### Detective Controls
- Real-time SIEM alerting (this rule)
- EDR behavioral monitoring for persistence
- File Integrity Monitoring on Tasks directory
- Regular scheduled task audits

## Real-World Context

### Threat Actor Usage
- **APT Groups:** APT29, APT28, Lazarus Group, Wizard Spider
- **Malware Families:** Emotet, TrickBot, Cobalt Strike, Ryuk, Conti
- **Ransomware:** Almost all ransomware uses scheduled tasks for persistence

### Industry Impact
- Used in 60%+ of ransomware deployments
- Common in APT campaigns for long-term access
- Frequently combined with other persistence (Run keys, services)
- Standard technique in post-exploitation toolkits

### Notable Attacks
- **SolarWinds (2020)** - Used scheduled tasks for SUNBURST persistence
- **Colonial Pipeline (2021)** - DarkSide ransomware scheduled task execution
- **Kaseya VSA (2021)** - REvil used scheduled tasks for mass deployment

## MITRE ATT&CK Mapping

**Primary Technique:** T1053.005 - Scheduled Task/Job: Scheduled Task

**Related Techniques:**
- T1053.002 - At (deprecated but still seen)
- T1543.003 - Windows Service
- T1547.001 - Registry Run Keys

**Kill Chain Phase:** 
- Persistence
- Privilege Escalation (if task runs as SYSTEM)
- Execution

**Common Follow-on Techniques:**
- T1059.001 - PowerShell execution
- T1027 - Obfuscated Files or Information
- T1105 - Ingress Tool Transfer

## References
- [MITRE ATT&CK T1053.005](https://attack.mitre.org/techniques/T1053/005/)
- [Microsoft Docs - Schtasks.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks)
- [Atomic Red Team T1053.005](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1053.005/T1053.005.md)
- [CISA - Scheduled Task Abuse](https://www.cisa.gov/uscert/ncas/alerts)
- [Sysmon Event ID 1](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)

## Version History
- v1.0 - Initial rule creation and validation via Atomic Red Team testing
- Detection validated: Feb 20, 2026
- Lab environment: Windows 11 Pro + ELK Stack 9.2.4

## Author
Adam Takeuchi - SOC Detection Lab Project