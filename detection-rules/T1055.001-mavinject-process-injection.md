# Detection Rule: Process Injection via Mavinject.exe

## MITRE ATT&CK
- **Technique ID:** T1055.001
- **Technique Name:** Process Injection: Dynamic-link Library Injection
- **Tactic:** Defense Evasion, Privilege Escalation
- **Severity:** High

## Description
Detects execution of mavinject.exe (Microsoft Application Virtualization Injector), a legitimate Windows binary that can be abused for process injection attacks. Attackers use this living-off-the-land binary (LOLBIN) to inject malicious code into running processes while evading application whitelisting controls.

## Technical Background
Mavinject.exe is a Microsoft-signed binary included in Windows 10+ for application virtualization. While it has legitimate uses in enterprise application deployment, it's rarely used in typical environments and has become a popular tool for attackers performing process injection.

## Detection Logic

### KQL Query (Kibana)
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "mavinject.exe"
```

### Enhanced Detection (Reduces False Positives)
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "mavinject.exe" AND
(process.parent.name: "powershell.exe" OR 
 process.parent.name: "cmd.exe" OR 
 process.parent.name: "wscript.exe" OR 
 process.parent.name: "cscript.exe")
```

### Key Detection Fields
| Field | Value in Attack | Why It Matters |
|-------|----------------|----------------|
| `event.code` | 1 | Process Creation event |
| `process.name` | mavinject.exe | The LOLBIN being abused |
| `process.parent.name` | powershell.exe | Suspicious parent process |
| `process.command_line` | Contains `/INJECTRUNNING` | DLL injection flag |
| `user.name` | Administrator | User context |

## Test Case - Atomic Red Team

### Execution Command
```powershell
Invoke-AtomicTest T1055.001 -TestNumbers 1
```

### Expected Behavior
1. PowerShell spawns mavinject.exe
2. Mavinject injects DLL into running process
3. Sysmon Event ID 1 generated immediately
4. Detection rule triggers within 30-60 seconds

### Lab Test Results
- **Environment:** Windows 11 Pro (homelab.local)
- **User Context:** Administrator
- **Detection Time:** ~30 seconds
- **Execution Date:** Feb 20, 2026 @ 14:08:37
- **Command Line:** `mavinject.exe 9104 /INJECTRUNNING C:\AtomicRedTeam\atomics\T1055.001\src\x64\T1055.001.dll`
- **Evidence:** Full process creation chain captured in Sysmon

## False Positives

### Known Legitimate Uses
1. **Enterprise Application Virtualization**
   - Microsoft App-V infrastructure
   - Citrix/VMware application streaming
   - **Frequency:** Rare (only in specific enterprise environments)

2. **Software Deployment Tools**
   - SCCM/Intune during app deployment
   - **Frequency:** Very rare

3. **Developer/Testing Environments**
   - Application compatibility testing
   - **Frequency:** Extremely rare

### Expected False Positive Rate
**<1% in typical environments**

In lab/development environments with App-V, may require whitelisting specific service accounts.

## Tuning Recommendations

### Level 1 - Basic Tuning
Whitelist known-good installation paths:
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "mavinject.exe" AND
NOT process.parent.executable: "C:\\Program Files\\Microsoft Application Virtualization\\*"
```

### Level 2 - Service Account Exclusions
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "mavinject.exe" AND
NOT user.name: ("NT AUTHORITY\\SYSTEM" OR "APPV_SERVICE_ACCOUNT")
```

### Level 3 - Correlation Rules
High-confidence detection combining multiple indicators:
```kql
(event.code: 1 AND process.name: "mavinject.exe") OR 
(event.code: 3 AND process.name: "mavinject.exe")
```

Look for mavinject.exe + network connections within 5 minutes = likely C2 communication.

## Investigation Playbook

### Immediate Actions (0-5 minutes)
1. **Verify Detection**
   - Check process.command_line for DLL path
   - Identify target process (PID in command line)
   - Review parent process chain
   
2. **Context Gathering**
   - What process was targeted for injection?
   - Is the DLL file still present on disk?
   - Check user account - expected behavior?

### Containment (5-15 minutes)
3. **Endpoint Actions**
   - If confirmed malicious: Isolate endpoint from network
   - Preserve memory dump for forensics
   - Collect full Sysmon logs for session

4. **Account Security**
   - Force password reset if credential theft suspected
   - Review recent account activity
   - Check for lateral movement indicators

### Investigation (15+ minutes)
5. **Deeper Analysis**
   - Analyze injected DLL (hash, strings, behavior)
   - Check for persistence mechanisms (Run keys, tasks, services)
   - Review network connections from target process
   - Search for similar activity on other endpoints

6. **Threat Intelligence**
   - Submit DLL hash to VirusTotal
   - Check OSINT for known campaigns
   - Review MITRE ATT&CK for common follow-on techniques

## Remediation Steps

### Short-term
1. Terminate mavinject.exe process
2. Kill target process (if malicious)
3. Delete malicious DLL from disk
4. Run full antivirus scan
5. Remove any persistence mechanisms

### Long-term
6. Implement application control policies (AppLocker/WDAC)
7. Restrict mavinject.exe execution to approved users/paths
8. Enable Protected Process Light (PPL) for critical processes
9. Deploy EDR for advanced behavioral detection
10. Security awareness training on LOLBIN abuse

## Prevention Recommendations

### Technical Controls
**Application Whitelisting:**
```powershell
# Block mavinject.exe for standard users via AppLocker
# Allow only from approved App-V deployment paths
```

**Attack Surface Reduction (Microsoft Defender):**
- Enable ASR rule: "Block process creations originating from PSExec and WMI commands"
- Enable ASR rule: "Block Office applications from injecting code into other processes"

**Least Privilege:**
- Remove local admin rights where not required
- Use LAPS for local admin password management
- Implement just-in-time admin access

### Detective Controls
- Real-time SIEM alerting (this rule)
- EDR behavioral analysis
- Network monitoring for C2 indicators
- File integrity monitoring on system directories

## Real-World Context

### Threat Actor Usage
- **APT Groups:** Wizard Spider, Cobalt Group, APT29
- **Malware Families:** TrickBot, Emotot, Qakbot, Cobalt Strike
- **Campaigns:** Commonly used in ransomware pre-deployment

### Industry Impact
- Part of "living off the land" (LOTL) technique trend
- Difficult to block due to legitimate Microsoft signing
- Frequently combined with other LOLBINS (regsvr32, rundll32)
- Used in 15-20% of advanced persistent threat campaigns

## MITRE ATT&CK Mapping

**Primary Technique:** T1055.001 - Process Injection: DLL Injection

**Related Techniques:**
- T1218 - Signed Binary Proxy Execution
- T1127 - Trusted Developer Utilities Proxy Execution
- T1106 - Native API

**Kill Chain Phase:** 
- Execution
- Defense Evasion
- Privilege Escalation

## References
- [MITRE ATT&CK T1055.001](https://attack.mitre.org/techniques/T1055/001/)
- [LOLBAS - Mavinject.exe](https://lolbas-project.github.io/lolbas/Binaries/Mavinject/)
- [Microsoft Docs - Sysmon Event ID 1](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)
- [Atomic Red Team T1055.001](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1055.001/T1055.001.md)
- [Elastic Detection Rules](https://www.elastic.co/guide/en/security/current/process-injection-detected.html)

## Version History
- v1.0 - Initial rule creation and validation via Atomic Red Team testing
- Detection validated: Feb 20, 2026
- Lab environment: Windows 11 Pro + ELK Stack 9.2.4

## Author
Adam Takeuchi - SOC Detection Lab Project