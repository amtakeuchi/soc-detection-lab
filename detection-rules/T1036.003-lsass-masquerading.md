# Detection Rule: LSASS Process Masquerading

## MITRE ATT&CK
- **Technique ID:** T1036.003
- **Technique Name:** Masquerading: Rename System Utilities
- **Tactic:** Defense Evasion
- **Severity:** Critical

## Description
Detects files named "lsass.exe" created or existing outside of the legitimate Windows System32 directory. Attackers commonly rename malware to impersonate legitimate Windows processes like LSASS (Local Security Authority Subsystem Service) to evade detection and appear legitimate to users and security tools.

## Technical Background
The legitimate lsass.exe is a critical Windows process responsible for enforcing security policies, handling authentication, and managing password changes. It should ONLY exist at `C:\Windows\System32\lsass.exe`. Any instance of lsass.exe in another location is either malware masquerading as this process or a precursor to credential dumping attacks.

## Detection Logic

### KQL Query (Kibana)
```kql
event.module: sysmon AND 
(event.code: 1 OR event.code: 11) AND 
file.name: "lsass.exe" AND 
NOT file.path: "C:\\Windows\\System32\\lsass.exe"
```

### Alternative Detection (Process Creation)
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "lsass.exe" AND 
NOT process.executable: "C:\\Windows\\System32\\lsass.exe"
```

### Key Detection Fields
| Field | Value in Attack | Why It Matters |
|-------|----------------|----------------|
| `event.code` | 11 | File Creation event |
| `file.name` | lsass.exe | Name attempting impersonation |
| `file.path` | C:\Windows\Temp\lsass.exe | WRONG LOCATION (not System32) |
| `process.name` | cmd.exe | Process that created the file |
| `user.name` | Administrator | User context |

## Test Case - Atomic Red Team

### Execution Command
```powershell
Invoke-AtomicTest T1036.003 -TestNumbers 1
```

### Expected Behavior
1. Test copies a file and renames it to lsass.exe
2. Places it in C:\Windows\Temp\ (or similar non-System32 location)
3. Sysmon Event ID 11 (File Creation) generated immediately
4. Detection rule triggers within seconds

### Lab Test Results
- **Environment:** Windows 11 Pro (homelab.local)
- **User Context:** Administrator
- **Detection Time:** Immediate (<10 seconds)
- **Execution Date:** Feb 20, 2026 @ 14:11:02
- **Fake File Location:** `C:\Windows\Temp\lsass.exe`
- **Created By:** cmd.exe
- **Evidence:** Sysmon File Creation event captured

## False Positives

### Known Legitimate Uses
**Essentially ZERO false positives.**

The legitimate lsass.exe is protected by Windows and cannot be moved, copied, or renamed under normal circumstances. Any detection of lsass.exe outside of System32 should be treated as **highly suspicious** and investigated immediately.

### Possible Edge Cases (Extremely Rare)
1. **Malware analysis labs** - Researchers extracting lsass.exe for analysis
2. **Forensic investigations** - IR teams copying system files for evidence
3. **Backup software** - System image backups (but would preserve full path)

**Expected False Positive Rate: <0.1%**

## Tuning Recommendations

### Level 1 - Whitelist Forensic Tools (Optional)
```kql
event.module: sysmon AND 
event.code: 11 AND 
file.name: "lsass.exe" AND 
NOT file.path: "C:\\Windows\\System32\\lsass.exe" AND
NOT process.name: ("FTKImager.exe" OR "WinPmem.exe")
```

### Level 2 - Alert on ANY Suspicious System Process Names
Expand to detect other commonly impersonated processes:
```kql
event.module: sysmon AND 
event.code: 11 AND 
(file.name: "lsass.exe" OR 
 file.name: "csrss.exe" OR 
 file.name: "winlogon.exe" OR 
 file.name: "services.exe") AND
NOT file.path: "C:\\Windows\\System32\\*"
```

### Level 3 - Correlation with Process Execution
Alert if the fake lsass.exe actually executes:
```kql
event.module: sysmon AND 
event.code: 1 AND 
process.name: "lsass.exe" AND 
NOT process.executable: "C:\\Windows\\System32\\lsass.exe"
```

## Investigation Playbook

### Immediate Actions (0-2 minutes)
1. **Verify Detection**
   - Check exact file path - confirm NOT in System32
   - Note which process created the file
   - Check file hash immediately

2. **Containment Decision**
   - **CRITICAL ALERT** - High likelihood of active threat
   - Consider immediate endpoint isolation
   - Preserve file for analysis (quarantine, don't delete)

### Containment (2-10 minutes)
3. **Endpoint Actions**
   - Isolate system from network
   - Kill any process associated with fake lsass.exe
   - Preserve memory dump
   - Collect full disk image if possible

4. **Account Security**
   - Force password reset for affected user account
   - Review logon activity for signs of credential use
   - Check for unauthorized privilege escalation

### Investigation (10+ minutes)
5. **Deeper Analysis**
   - Submit file hash to VirusTotal
   - Static analysis: strings, PE header, compiler artifacts
   - Dynamic analysis: sandbox execution (isolated environment)
   - Check for other masquerading files on system
   - Review Sysmon logs for full attack timeline

6. **Lateral Movement Check**
   - Search other endpoints for same file hash
   - Review authentication logs for this user account
   - Check for unusual network connections from affected system
   - Investigate any scheduled tasks or persistence mechanisms

## Remediation Steps

### Immediate
1. Quarantine/delete the fake lsass.exe file
2. Terminate any processes spawned from it
3. Run full antivirus/EDR scan
4. Check for additional malware droppers
5. Review and remove any persistence mechanisms

### Short-term
6. Reset credentials for affected user account
7. Review and audit all local administrator accounts
8. Check for backdoors or reverse shells
9. Analyze network traffic logs for C2 communication
10. Document IOCs (file hash, network indicators, TTPs)

### Long-term
11. Deploy application whitelisting (only allow execution from approved paths)
12. Enable Windows Defender Attack Surface Reduction rules
13. Implement File Integrity Monitoring on System32
14. Deploy EDR for behavioral detection
15. Security awareness training on social engineering

## Prevention Recommendations

### Technical Controls
**File Integrity Monitoring:**
- Monitor System32 for unauthorized file creation
- Alert on any changes to critical system files
- Use tools like OSSEC, Tripwire, or native Windows auditing

**Application Whitelisting:**
```powershell
# AppLocker rule: Only allow executables from System32, Program Files
# Block execution from Temp, Downloads, AppData
```

**Windows Defender ASR:**
- Enable: "Block executable files from running unless they meet prevalence, age, or trusted list criteria"
- Enable: "Block executable content from email client and webmail"

**Least Privilege:**
- Remove local admin rights from standard users
- Implement LAPS for admin password management
- Require approval for administrative actions

### Detective Controls
- Real-time SIEM alerting (this rule)
- EDR behavioral monitoring
- Regular threat hunting for masquerading indicators
- Baseline normal process execution patterns

## Real-World Context

### Threat Actor Usage
- **Malware Families:** Emotet, TrickBot, Ryuk, Conti, LockBit
- **APT Groups:** APT28, APT29, Lazarus Group
- **Campaigns:** Pre-ransomware deployment, credential theft, persistence

### Industry Impact
- Used in 40%+ of sophisticated malware campaigns
- Common in ransomware kill chains
- Frequently combined with credential dumping
- Standard technique for maintaining stealth

### Notable Attacks
- **WannaCry** - Used process masquerading for persistence
- **NotPetya** - Impersonated legitimate Windows processes
- **Emotet** - Routinely renames payloads to system process names

## MITRE ATT&CK Mapping

**Primary Technique:** T1036.003 - Masquerading: Rename System Utilities

**Related Techniques:**
- T1036.004 - Masquerading: Masquerade Task or Service
- T1036.005 - Masquerading: Match Legitimate Name or Location
- T1564 - Hide Artifacts

**Kill Chain Phase:** Defense Evasion

**Common Follow-on Techniques:**
- T1003.001 - Credential Dumping (why fake lsass.exe)
- T1055 - Process Injection
- T1053 - Scheduled Task/Job (persistence)

## References
- [MITRE ATT&CK T1036.003](https://attack.mitre.org/techniques/T1036/003/)
- [Microsoft Docs - LSASS Process](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection)
- [Atomic Red Team T1036.003](https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1036.003/T1036.003.md)
- [Sysmon Event ID 11 - File Creation](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon)
- [CISA Alert - Masquerading Techniques](https://www.cisa.gov/uscert/ncas/alerts)

## Version History
- v1.0 - Initial rule creation and validation via Atomic Red Team testing
- Detection validated: Feb 20, 2026
- Lab environment: Windows 11 Pro + ELK Stack 9.2.4

## Author
Adam Takeuchi - SOC Detection Lab Project